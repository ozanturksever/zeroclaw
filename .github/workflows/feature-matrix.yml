name: Feature Matrix

on:
    push:
        branches: [dev, main]
        paths:
            - "Cargo.toml"
            - "Cargo.lock"
            - "src/**"
            - "crates/**"
            - "tests/**"
            - "scripts/ci/nightly_matrix_report.py"
            - ".github/release/nightly-owner-routing.json"
            - ".github/workflows/feature-matrix.yml"
    pull_request:
        branches: [dev, main]
        paths:
            - "Cargo.toml"
            - "Cargo.lock"
            - "src/**"
            - "crates/**"
            - "tests/**"
            - "scripts/ci/nightly_matrix_report.py"
            - ".github/release/nightly-owner-routing.json"
            - ".github/workflows/feature-matrix.yml"
    merge_group:
        branches: [dev, main]
    schedule:
        - cron: "30 4 * * 1" # Weekly Monday 04:30 UTC
    workflow_dispatch:

concurrency:
    group: feature-matrix-${{ github.event.pull_request.number || github.sha }}
    cancel-in-progress: true

permissions:
    contents: read

env:
    CARGO_TERM_COLOR: always

jobs:
    feature-check:
        name: Matrix Lane (${{ matrix.name }})
        runs-on: blacksmith-2vcpu-ubuntu-2404
        timeout-minutes: 55
        strategy:
            fail-fast: false
            matrix:
                include:
                    - name: default
                      command: cargo check --locked
                      install_libudev: false
                    - name: whatsapp-web
                      command: cargo check --locked --no-default-features --features whatsapp-web
                      install_libudev: false
                    - name: browser-native
                      command: cargo check --locked --no-default-features --features browser-native
                      install_libudev: false
                    - name: nightly-all-features
                      command: cargo check --locked --all-features
                      install_libudev: true
        steps:
            - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
              with:
                  fetch-depth: 0

            - uses: dtolnay/rust-toolchain@631a55b12751854ce901bb631d5902ceb48146f7 # stable
              with:
                  toolchain: 1.92.0

            - uses: useblacksmith/rust-cache@f53e7f127245d2a269b3d90879ccf259876842d5 # v3
              with:
                  prefix-key: feature-matrix-${{ matrix.name }}

            - name: Install Linux deps for all-features lane
              if: matrix.install_libudev
              run: |
                  sudo apt-get update -qq
                  sudo apt-get install -y --no-install-recommends libudev-dev pkg-config

            - name: Run matrix lane command
              id: lane
              shell: bash
              run: |
                  set -euo pipefail
                  mkdir -p artifacts
                  started_at="$(date +%s)"
                  set +e
                  bash -lc "${{ matrix.command }}"
                  status=$?
                  set -e
                  finished_at="$(date +%s)"
                  duration="$((finished_at - started_at))"

                  lane_status="success"
                  if [ "$status" -ne 0 ]; then
                    lane_status="failure"
                  fi

                  cat > "artifacts/nightly-result-${{ matrix.name }}.json" <<EOF
                  {
                    "lane": "${{ matrix.name }}",
                    "status": "${lane_status}",
                    "exit_code": ${status},
                    "duration_seconds": ${duration},
                    "command": "${{ matrix.command }}"
                  }
                  EOF

                  {
                    echo "### Feature Matrix Lane: ${{ matrix.name }}"
                    echo "- Command: \`${{ matrix.command }}\`"
                    echo "- Status: ${lane_status}"
                    echo "- Exit code: ${status}"
                    echo "- Duration (s): ${duration}"
                  } >> "$GITHUB_STEP_SUMMARY"

                  echo "lane_status=${lane_status}" >> "$GITHUB_OUTPUT"
                  echo "lane_exit_code=${status}" >> "$GITHUB_OUTPUT"

            - name: Upload lane report
              if: always()
              uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
              with:
                  name: feature-matrix-${{ matrix.name }}
                  path: artifacts/nightly-result-${{ matrix.name }}.json
                  if-no-files-found: error
                  retention-days: 21

            - name: Enforce lane success
              if: steps.lane.outputs.lane_status != 'success'
              shell: bash
              run: |
                  set -euo pipefail
                  code="${{ steps.lane.outputs.lane_exit_code }}"
                  if [[ "$code" =~ ^[0-9]+$ ]]; then
                    # shellcheck disable=SC2242
                    exit "$code"
                  fi
                  echo "Invalid lane exit code: $code" >&2
                  exit 1

    summary:
        name: Feature Matrix Summary
        needs: [feature-check]
        if: always()
        runs-on: blacksmith-2vcpu-ubuntu-2404
        steps:
            - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

            - name: Download lane reports
              uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
              with:
                  path: artifacts

            - name: Aggregate matrix summary
              shell: bash
              run: |
                  set -euo pipefail
                  python3 scripts/ci/nightly_matrix_report.py \
                    --input-dir artifacts \
                    --owners-file .github/release/nightly-owner-routing.json \
                    --output-json artifacts/feature-matrix-summary.json \
                    --output-md artifacts/feature-matrix-summary.md \
                    --fail-on-failure

            - name: Publish summary
              shell: bash
              run: |
                  set -euo pipefail
                  cat artifacts/feature-matrix-summary.md >> "$GITHUB_STEP_SUMMARY"

            - name: Upload feature matrix summary artifact
              if: always()
              uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
              with:
                  name: feature-matrix-summary
                  path: |
                      artifacts/feature-matrix-summary.json
                      artifacts/feature-matrix-summary.md
                  if-no-files-found: error
                  retention-days: 21
